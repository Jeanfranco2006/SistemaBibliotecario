/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package SistemaBibliotecario.vistaBlibliotecario;

import java.io.File;
import java.util.Date;
import java.util.List;

import javax.swing.JFileChooser;
import javax.swing.JOptionPane;

import SistemaBibliotecario.Dao.ReporteDAO;
import SistemaBibliotecario.Modelos.Prestamo;
import SistemaBibliotecario.Modelos.SesionActual;
import SistemaBibliotecario.VistaLogin.login;
import java.text.SimpleDateFormat;

/**
 *
 * @author User
 */
public class reportes extends javax.swing.JPanel {

    /**
     * Creates new form vista
     */
    public reportes() {
        initComponents();
        inicializarComboboxCategorias();
        
        if (SesionActual.nombre != null && !SesionActual.nombre.isEmpty()) {
        lblNombreBibliotecario.setText(" " + SesionActual.nombre);
    } else {
        lblNombreBibliotecario.setText("Bienvenido: Bibliotecario");
    }
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jLabel4 = new javax.swing.JLabel();
        jPanel3 = new javax.swing.JPanel();
        jLabel2 = new javax.swing.JLabel();
        jPanel4 = new javax.swing.JPanel();
        jLabel5 = new javax.swing.JLabel();
        btnGenerarReportePrestamo = new javax.swing.JButton();
        jLabel10 = new javax.swing.JLabel();
        jLabel11 = new javax.swing.JLabel();
        jDateChooserDesdePrestamos = new com.toedter.calendar.JDateChooser();
        jDateChooserHastaPrestamos = new com.toedter.calendar.JDateChooser();
        jPanel5 = new javax.swing.JPanel();
        jLabel9 = new javax.swing.JLabel();
        btnGenerarReporteLibros = new javax.swing.JButton();
        jLabel3 = new javax.swing.JLabel();
        cbxCategoria = new javax.swing.JComboBox<>();
        jrtbnMenosPrestados = new javax.swing.JRadioButton();
        jrbtnPopulares = new javax.swing.JRadioButton();
        jdcDesdeLibros = new com.toedter.calendar.JDateChooser();
        jdcHastaLibro = new com.toedter.calendar.JDateChooser();
        jLabel12 = new javax.swing.JLabel();
        jLabel13 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        jLabel7 = new javax.swing.JLabel();
        jPanel2 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        btnSalir = new javax.swing.JButton();
        btnInicio = new javax.swing.JButton();
        btnUsuarios = new javax.swing.JButton();
        btnLibros = new javax.swing.JButton();
        btnPrestamos = new javax.swing.JButton();
        btnReportes = new javax.swing.JButton();
        lblNombreBibliotecario = new javax.swing.JLabel();
        jLabel8 = new javax.swing.JLabel();

        jPanel1.setBackground(new java.awt.Color(236, 240, 241));
        jPanel1.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));
        jPanel1.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jLabel4.setIcon(new javax.swing.ImageIcon(getClass().getResource("/logo.jpeg"))); // NOI18N
        jPanel1.add(jLabel4, new org.netbeans.lib.awtextra.AbsoluteConstraints(1080, 40, 110, 80));

        jPanel3.setBackground(new java.awt.Color(19, 38, 76));
        jPanel3.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jLabel2.setFont(new java.awt.Font("Segoe UI", 1, 12)); // NOI18N
        jLabel2.setForeground(new java.awt.Color(255, 255, 255));
        jLabel2.setText("Vista Generaci√≥n de Reportes");
        jPanel3.add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(14, 8, -1, -1));

        jPanel1.add(jPanel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(300, 0, 900, 30));

        jPanel4.setBackground(new java.awt.Color(255, 255, 255));
        jPanel4.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));
        jPanel4.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jLabel5.setFont(new java.awt.Font("Segoe UI Black", 1, 14)); // NOI18N
        jLabel5.setText("REPORTES DE PR√âSTAMOS");
        jPanel4.add(jLabel5, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 10, -1, -1));

        btnGenerarReportePrestamo.setBackground(new java.awt.Color(19, 38, 76));
        btnGenerarReportePrestamo.setFont(new java.awt.Font("Segoe UI Black", 1, 18)); // NOI18N
        btnGenerarReportePrestamo.setForeground(new java.awt.Color(255, 255, 255));
        btnGenerarReportePrestamo.setText("GENERAR REPORTE");
        btnGenerarReportePrestamo.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnGenerarReportePrestamoActionPerformed(evt);
            }
        });
        jPanel4.add(btnGenerarReportePrestamo, new org.netbeans.lib.awtextra.AbsoluteConstraints(40, 260, 280, 50));

        jLabel10.setText("HASTA:");
        jPanel4.add(jLabel10, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 170, -1, -1));

        jLabel11.setText("DESDE:");
        jPanel4.add(jLabel11, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 50, -1, -1));
        jPanel4.add(jDateChooserDesdePrestamos, new org.netbeans.lib.awtextra.AbsoluteConstraints(70, 40, 230, 40));
        jPanel4.add(jDateChooserHastaPrestamos, new org.netbeans.lib.awtextra.AbsoluteConstraints(70, 160, 230, 40));

        jPanel1.add(jPanel4, new org.netbeans.lib.awtextra.AbsoluteConstraints(350, 180, 380, 320));

        jPanel5.setBackground(new java.awt.Color(255, 255, 255));
        jPanel5.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));
        jPanel5.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jLabel9.setFont(new java.awt.Font("Segoe UI Black", 1, 14)); // NOI18N
        jLabel9.setText("REPORTES DE LIBROS");
        jPanel5.add(jLabel9, new org.netbeans.lib.awtextra.AbsoluteConstraints(100, 10, -1, -1));

        btnGenerarReporteLibros.setBackground(new java.awt.Color(19, 38, 76));
        btnGenerarReporteLibros.setFont(new java.awt.Font("Segoe UI Black", 1, 18)); // NOI18N
        btnGenerarReporteLibros.setForeground(new java.awt.Color(255, 255, 255));
        btnGenerarReporteLibros.setText("GENERAR REPORTE");
        btnGenerarReporteLibros.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnGenerarReporteLibrosActionPerformed(evt);
            }
        });
        jPanel5.add(btnGenerarReporteLibros, new org.netbeans.lib.awtextra.AbsoluteConstraints(60, 260, 280, 50));

        jLabel3.setText("Hasta:");
        jPanel5.add(jLabel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(250, 180, -1, -1));

        jPanel5.add(cbxCategoria, new org.netbeans.lib.awtextra.AbsoluteConstraints(110, 140, -1, -1));

        jrtbnMenosPrestados.setText("Menos Prestados");
        jrtbnMenosPrestados.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jrtbnMenosPrestadosActionPerformed(evt);
            }
        });
        jPanel5.add(jrtbnMenosPrestados, new org.netbeans.lib.awtextra.AbsoluteConstraints(40, 90, -1, -1));

        jrbtnPopulares.setText("M√°s Prestados");
        jPanel5.add(jrbtnPopulares, new org.netbeans.lib.awtextra.AbsoluteConstraints(40, 60, -1, -1));
        jPanel5.add(jdcDesdeLibros, new org.netbeans.lib.awtextra.AbsoluteConstraints(60, 200, -1, -1));
        jPanel5.add(jdcHastaLibro, new org.netbeans.lib.awtextra.AbsoluteConstraints(250, 200, -1, -1));

        jLabel12.setText("Categor√≠a");
        jPanel5.add(jLabel12, new org.netbeans.lib.awtextra.AbsoluteConstraints(50, 140, -1, -1));

        jLabel13.setText("Desde:");
        jPanel5.add(jLabel13, new org.netbeans.lib.awtextra.AbsoluteConstraints(60, 180, -1, -1));

        jPanel1.add(jPanel5, new org.netbeans.lib.awtextra.AbsoluteConstraints(770, 180, 400, 320));

        jLabel6.setFont(new java.awt.Font("Segoe UI Black", 1, 36)); // NOI18N
        jLabel6.setText("BIENVENIDO ");
        jPanel1.add(jLabel6, new org.netbeans.lib.awtextra.AbsoluteConstraints(350, 40, 270, -1));

        jLabel7.setFont(new java.awt.Font("Segoe UI Black", 1, 18)); // NOI18N
        jLabel7.setText("INFORMES GENERADOS RECIENTEMENTE");
        jPanel1.add(jLabel7, new org.netbeans.lib.awtextra.AbsoluteConstraints(350, 530, -1, -1));

        jPanel2.setBackground(new java.awt.Color(19, 38, 76));
        jPanel2.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jLabel1.setFont(new java.awt.Font("Segoe UI Black", 1, 24)); // NOI18N
        jLabel1.setForeground(new java.awt.Color(255, 255, 255));
        jLabel1.setText("BiblioSys");
        jPanel2.add(jLabel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(90, 30, -1, -1));

        btnSalir.setFont(new java.awt.Font("Segoe UI Black", 1, 14)); // NOI18N
        btnSalir.setText("SALIR");
        btnSalir.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSalirActionPerformed(evt);
            }
        });
        jPanel2.add(btnSalir, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 621, 240, 44));

        btnInicio.setBackground(new java.awt.Color(0, 51, 102));
        btnInicio.setFont(new java.awt.Font("Segoe UI Black", 1, 14)); // NOI18N
        btnInicio.setForeground(new java.awt.Color(255, 255, 255));
        btnInicio.setText("INICIO");
        btnInicio.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnInicioActionPerformed(evt);
            }
        });
        jPanel2.add(btnInicio, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 99, 240, 80));

        btnUsuarios.setBackground(new java.awt.Color(0, 51, 102));
        btnUsuarios.setFont(new java.awt.Font("Segoe UI Black", 1, 14)); // NOI18N
        btnUsuarios.setForeground(new java.awt.Color(255, 255, 255));
        btnUsuarios.setText("USUARIOS");
        btnUsuarios.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnUsuariosActionPerformed(evt);
            }
        });
        jPanel2.add(btnUsuarios, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 180, 240, 80));

        btnLibros.setBackground(new java.awt.Color(0, 51, 102));
        btnLibros.setFont(new java.awt.Font("Segoe UI Black", 1, 14)); // NOI18N
        btnLibros.setForeground(new java.awt.Color(255, 255, 255));
        btnLibros.setText("LIBROS");
        btnLibros.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnLibrosActionPerformed(evt);
            }
        });
        jPanel2.add(btnLibros, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 260, 240, 80));

        btnPrestamos.setBackground(new java.awt.Color(0, 51, 102));
        btnPrestamos.setFont(new java.awt.Font("Segoe UI Black", 1, 14)); // NOI18N
        btnPrestamos.setForeground(new java.awt.Color(255, 255, 255));
        btnPrestamos.setText("PRESTAMOS");
        btnPrestamos.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnPrestamosActionPerformed(evt);
            }
        });
        jPanel2.add(btnPrestamos, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 340, 240, 80));

        btnReportes.setBackground(new java.awt.Color(0, 0, 0));
        btnReportes.setFont(new java.awt.Font("Segoe UI Black", 1, 14)); // NOI18N
        btnReportes.setForeground(new java.awt.Color(255, 255, 255));
        btnReportes.setText("REPORTES");
        jPanel2.add(btnReportes, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 420, 240, 80));

        lblNombreBibliotecario.setFont(new java.awt.Font("Segoe UI Historic", 1, 18)); // NOI18N
        lblNombreBibliotecario.setForeground(new java.awt.Color(255, 255, 255));
        lblNombreBibliotecario.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        lblNombreBibliotecario.setText("                                ");
        lblNombreBibliotecario.setBorder(javax.swing.BorderFactory.createBevelBorder(javax.swing.border.BevelBorder.RAISED));
        jPanel2.add(lblNombreBibliotecario, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 569, 240, 40));

        jPanel1.add(jPanel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 0, 300, 700));

        jLabel8.setFont(new java.awt.Font("Segoe UI Black", 1, 18)); // NOI18N
        jLabel8.setText("GENERACI√ìN DE REPORTES");
        jPanel1.add(jLabel8, new org.netbeans.lib.awtextra.AbsoluteConstraints(350, 130, -1, -1));

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addGap(0, 0, Short.MAX_VALUE)
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, 700, javax.swing.GroupLayout.PREFERRED_SIZE))
        );
    }// </editor-fold>//GEN-END:initComponents

    private void btnGenerarReporteLibrosActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnGenerarReporteLibrosActionPerformed
try {
        // Validar fechas
        if (jdcDesdeLibros.getDate() == null || jdcHastaLibro.getDate() == null) {
            JOptionPane.showMessageDialog(this, 
                "Por favor, seleccione ambas fechas para el reporte de libros.", 
                "Fechas requeridas", 
                JOptionPane.WARNING_MESSAGE);
            return;
        }
        
        Date fechaDesde = jdcDesdeLibros.getDate();
        Date fechaHasta = jdcHastaLibro.getDate();
        
        // Validar rango de fechas
        if (fechaDesde.after(fechaHasta)) {
            JOptionPane.showMessageDialog(this, 
                "La fecha 'Desde' no puede ser mayor que la fecha 'Hasta'.", 
                "Fechas inv√°lidas", 
                JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        // Validar que se haya seleccionado un tipo de reporte
        if (!jrbtnPopulares.isSelected() && !jrtbnMenosPrestados.isSelected()) {
            JOptionPane.showMessageDialog(this, 
                "Por favor, seleccione un tipo de reporte (M√°s populares o Menos prestados).", 
                "Tipo requerido", 
                JOptionPane.WARNING_MESSAGE);
            return;
        }
        
        // Obtener la categor√≠a seleccionada
        String categoria = null;
        if (cbxCategoria.getSelectedItem() != null && !cbxCategoria.getSelectedItem().toString().equals("Todas")) {
            categoria = cbxCategoria.getSelectedItem().toString();
        }
        
        boolean esPopular = jrbtnPopulares.isSelected();
        
        ReporteDAO reporteDAO = new ReporteDAO();
        
        // Seleccionar ubicaci√≥n para guardar
        JFileChooser fileChooser = new JFileChooser();
        fileChooser.setDialogTitle("Guardar reporte de libros");
        
        String nombreArchivo = esPopular ? "reporte_libros_populares.xlsx" : "reporte_libros_menos_prestados.xlsx";
        fileChooser.setSelectedFile(new java.io.File(nombreArchivo));
        
        int userSelection = fileChooser.showSaveDialog(this);
        
        if (userSelection == JFileChooser.APPROVE_OPTION) {
            java.io.File fileToSave = fileChooser.getSelectedFile();
            String rutaArchivo = fileToSave.getAbsolutePath();
            
            if (!rutaArchivo.toLowerCase().endsWith(".xlsx")) {
                rutaArchivo += ".xlsx";
            }
            
            boolean exito = reporteDAO.generarReporteLibrosExcel(fechaDesde, fechaHasta, esPopular, categoria, rutaArchivo);
            
            String tipoReporte = esPopular ? "Libros M√°s Populares" : "Libros Menos Prestados";
            String infoCategoria = categoria != null ? "Categor√≠a: " + categoria : "Todas las categor√≠as";
            
            if (exito) {
                JOptionPane.showMessageDialog(this, 
                    "‚úÖ Reporte de " + tipoReporte + " generado exitosamente!\n" +
                    "üìç Ubicaci√≥n: " + rutaArchivo + "\n" +
                    "üìÖ Per√≠odo: " + new SimpleDateFormat("dd/MM/yyyy").format(fechaDesde) + 
                    " a " + new SimpleDateFormat("dd/MM/yyyy").format(fechaHasta) + "\n" +
                    "üìö " + infoCategoria, 
                    "Reporte completado", 
                    JOptionPane.INFORMATION_MESSAGE);
            } else {
                JOptionPane.showMessageDialog(this, 
                    "‚ùå Error al generar el reporte de libros.", 
                    "Error", 
                    JOptionPane.ERROR_MESSAGE);
            }
        }
        
    } catch (Exception e) {
        JOptionPane.showMessageDialog(this, 
            "‚ùå Error al generar reporte de libros: " + e.getMessage(), 
            "Error", 
            JOptionPane.ERROR_MESSAGE);
        e.printStackTrace();
    }
    }//GEN-LAST:event_btnGenerarReporteLibrosActionPerformed

    private void jrtbnMenosPrestadosActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jrtbnMenosPrestadosActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_jrtbnMenosPrestadosActionPerformed

    private void btnUsuariosActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnUsuariosActionPerformed
javax.swing.JFrame frame = new javax.swing.JFrame("Gesti√≥n de Usuarios");
    frame.setDefaultCloseOperation(javax.swing.JFrame.EXIT_ON_CLOSE);
    frame.setContentPane(new SistemaBibliotecario.vistaBlibliotecario.usuarios()); // agrega el panel
    frame.pack(); // ajusta al tama√±o preferido
    frame.setLocationRelativeTo(null); // centra la ventana
    frame.setVisible(true); // muestra la nueva ventana

    // Cierra la ventana actual
    javax.swing.SwingUtilities.getWindowAncestor(this).dispose();        // TODO add your handling code here:
    }//GEN-LAST:event_btnUsuariosActionPerformed

    private void btnLibrosActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnLibrosActionPerformed
javax.swing.JFrame frame = new javax.swing.JFrame("Gesti√≥n de Libros");
    frame.setDefaultCloseOperation(javax.swing.JFrame.EXIT_ON_CLOSE);
    frame.setContentPane(new SistemaBibliotecario.vistaBlibliotecario.libros()); // agrega el panel
    frame.pack(); // ajusta al tama√±o preferido
    frame.setLocationRelativeTo(null); // centra la ventana
    frame.setVisible(true); // muestra la nueva ventana

    // Cierra la ventana actual
    javax.swing.SwingUtilities.getWindowAncestor(this).dispose();        // TODO add your handling code here:
    }//GEN-LAST:event_btnLibrosActionPerformed

    private void btnPrestamosActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnPrestamosActionPerformed
javax.swing.JFrame frame = new javax.swing.JFrame("Gesti√≥n de Prestamos");
    frame.setDefaultCloseOperation(javax.swing.JFrame.EXIT_ON_CLOSE);
    frame.setContentPane(new SistemaBibliotecario.vistaBlibliotecario.prestamos()); // agrega el panel
    frame.pack(); // ajusta al tama√±o preferido
    frame.setLocationRelativeTo(null); // centra la ventana
    frame.setVisible(true); // muestra la nueva ventana

    // Cierra la ventana actual
    javax.swing.SwingUtilities.getWindowAncestor(this).dispose();        // TODO add your handling code here:
    }//GEN-LAST:event_btnPrestamosActionPerformed

    private void btnGenerarReportePrestamoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnGenerarReportePrestamoActionPerformed
 try {
        // Obtener fechas de los JDateChooser (no JCalendar)
        Date fechaDesde = jDateChooserDesdePrestamos.getDate();
        Date fechaHasta = jDateChooserHastaPrestamos.getDate();
        
        if (fechaDesde == null || fechaHasta == null) {
            JOptionPane.showMessageDialog(this, "‚ö†Ô∏è Por favor, seleccione ambas fechas.", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        if (fechaDesde.after(fechaHasta)) {
            JOptionPane.showMessageDialog(this, "‚ö†Ô∏è La fecha 'Desde' no puede ser mayor que la fecha 'Hasta'.", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        // Obtener el DNI del bibliotecario logueado (debes tener una clase SesionActual)
        String dniBibliotecario = SesionActual.dni; // Ajusta seg√∫n tu implementaci√≥n
        
        if (dniBibliotecario == null || dniBibliotecario.isEmpty()) {
            JOptionPane.showMessageDialog(this, "‚ùå No se pudo identificar al bibliotecario.", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        // Seleccionar ubicaci√≥n para guardar el archivo
        JFileChooser fileChooser = new JFileChooser();
        fileChooser.setDialogTitle("Guardar reporte de pr√©stamos");
        fileChooser.setSelectedFile(new File("reporte_prestamos.xlsx"));
        
        int userSelection = fileChooser.showSaveDialog(this);
        if (userSelection != JFileChooser.APPROVE_OPTION) {
            return;
        }
        
        String rutaArchivo = fileChooser.getSelectedFile().getAbsolutePath();
        if (!rutaArchivo.toLowerCase().endsWith(".xlsx")) {
            rutaArchivo += ".xlsx";
        }
        
        // Generar el reporte Excel usando el DAO corregido
        ReporteDAO reporteDAO = new ReporteDAO();
        boolean exito = reporteDAO.generarReportePrestamosExcel(fechaDesde, fechaHasta, dniBibliotecario, rutaArchivo);
        
        if (exito) {
            // Obtener estad√≠sticas para mostrar en el mensaje
            List<Prestamo> prestamos = reporteDAO.obtenerPrestamosPorFechaYBibliotecario(fechaDesde, fechaHasta, dniBibliotecario);
            long totalPrestamos = prestamos.size();
            long prestamosActivos = prestamos.stream().filter(p -> "activo".equals(p.getEstado())).count();
            long prestamosDevueltos = prestamos.stream().filter(p -> "devuelto".equals(p.getEstado())).count();
            long prestamosVencidos = prestamos.stream().filter(p -> "vencido".equals(p.getEstado())).count();
            
            String estadisticas = String.format(
                "ESTAD√çSTICAS DEL REPORTE:\n" +
                "Total de Pr√©stamos: %d\n" +
                "Pr√©stamos Activos: %d\n" +
                "Pr√©stamos Devueltos: %d\n" +
                "Pr√©stamos Vencidos: %d",
                totalPrestamos, prestamosActivos, prestamosDevueltos, prestamosVencidos
            );
            
            JOptionPane.showMessageDialog(this, 
                "‚úÖ Reporte Excel generado exitosamente:\n" + rutaArchivo + 
                "\n\n" + estadisticas,
                "Reporte Generado", 
                JOptionPane.INFORMATION_MESSAGE);
        } else {
            JOptionPane.showMessageDialog(this, "‚ùå Error al generar el reporte.", "Error", JOptionPane.ERROR_MESSAGE);
        }
        
    } catch (Exception e) {
        JOptionPane.showMessageDialog(this, "‚ùå Error: " + e.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);
        e.printStackTrace();
    }


    }//GEN-LAST:event_btnGenerarReportePrestamoActionPerformed

    private void btnInicioActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnInicioActionPerformed
         javax.swing.JFrame frame = new javax.swing.JFrame("ventana de inicio");
    frame.setDefaultCloseOperation(javax.swing.JFrame.EXIT_ON_CLOSE);
    frame.setContentPane(new SistemaBibliotecario.vistaBlibliotecario.inicio()); // agrega el panel
    frame.pack(); // ajusta al tama√±o preferido
    frame.setLocationRelativeTo(null); // centra la ventana
    frame.setVisible(true); // muestra la nueva ventana

    // Cierra la ventana actual
    javax.swing.SwingUtilities.getWindowAncestor(this).dispose(); // TODO add your handling code here:
    }//GEN-LAST:event_btnInicioActionPerformed

    private void btnSalirActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSalirActionPerformed
       login view = new login();  
    view.setLocationRelativeTo(null); // Centrar la ventana
    view.setVisible(true); // Mostrar el login

    // Cerrar la ventana actual
    javax.swing.SwingUtilities.getWindowAncestor(this).dispose();   // TODO add your handling code here:
    }//GEN-LAST:event_btnSalirActionPerformed
private void inicializarComboboxCategorias() {
    try {
        cbxCategoria.removeAllItems();
        cbxCategoria.addItem("Todas"); // Opci√≥n por defecto
        
        // ‚úÖ Obtener categor√≠as de la base de datos
        ReporteDAO reporteDAO = new ReporteDAO();
        List<String> categorias = reporteDAO.obtenerTodasLasCategorias();
        
        // ‚úÖ Agregar categor√≠as REALES de la BD al combobox
        for (String categoria : categorias) {
            cbxCategoria.addItem(categoria);
        }
        
        cbxCategoria.setSelectedIndex(0);
        
        // ‚úÖ Debug: mostrar en consola lo que se carg√≥
        System.out.println("‚úÖ Categor√≠as cargadas desde BD:");
        for (int i = 0; i < cbxCategoria.getItemCount(); i++) {
            System.out.println("   " + (i + 1) + ". " + cbxCategoria.getItemAt(i));
        }
        
    } catch (Exception e) {
        System.err.println("‚ùå Error al cargar categor√≠as: " + e.getMessage());
        e.printStackTrace();
        
        
    }
}

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnGenerarReporteLibros;
    private javax.swing.JButton btnGenerarReportePrestamo;
    private javax.swing.JButton btnInicio;
    private javax.swing.JButton btnLibros;
    private javax.swing.JButton btnPrestamos;
    private javax.swing.JButton btnReportes;
    private javax.swing.JButton btnSalir;
    private javax.swing.JButton btnUsuarios;
    private javax.swing.JComboBox<String> cbxCategoria;
    private com.toedter.calendar.JDateChooser jDateChooserDesdePrestamos;
    private com.toedter.calendar.JDateChooser jDateChooserHastaPrestamos;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel10;
    private javax.swing.JLabel jLabel11;
    private javax.swing.JLabel jLabel12;
    private javax.swing.JLabel jLabel13;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private com.toedter.calendar.JDateChooser jdcDesdeLibros;
    private com.toedter.calendar.JDateChooser jdcHastaLibro;
    private javax.swing.JRadioButton jrbtnPopulares;
    private javax.swing.JRadioButton jrtbnMenosPrestados;
    private javax.swing.JLabel lblNombreBibliotecario;
    // End of variables declaration//GEN-END:variables
}
